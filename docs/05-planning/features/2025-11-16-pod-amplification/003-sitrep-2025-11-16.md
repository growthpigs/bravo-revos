# Pod Amplification SITREP - 2025-11-16

**Feature:** LinkedIn Pod Amplification with Playwright Automation
**Branch:** `feat/v2-agentkit-architecture`
**Status:** Infrastructure Complete, Testing Pending Real Unipile Accounts
**Session:** Continuation from pod onboarding security fixes

---

## Executive Summary

‚úÖ **Queue Infrastructure:** Complete - BullMQ + Redis working
‚úÖ **Worker System:** Complete - Amplification + Repost workers running
‚úÖ **Database:** Complete - Migrations applied, test data created
‚úÖ **Playwright Automation:** Complete - 300+ lines of LinkedIn repost logic
‚ö†Ô∏è **Testing:** Blocked - All pod members have fake Unipile account IDs
‚è∏Ô∏è **Schema Refactor:** Deferred to tomorrow (clients ‚Üí pods restructure)

---

## What Was Built

### 1. Queue Infrastructure (`lib/queues/pod-queue.ts`)
- **Two-tier queue system:**
  - `pod-amplification` queue: Orchestrates amplification across pod members
  - `pod-repost` queue: Individual repost jobs with browser automation
- **BullMQ configuration:**
  - Exponential backoff retries (3 attempts for amplification, 2 for reposts)
  - Job cleanup (keep last 100 completed, 500 failed)
  - Redis connection with auto-retry
- **Job interfaces:**
  - `PodAmplificationJob`: Post metadata + pod context
  - `PodRepostJob`: Member-specific repost data + Unipile account ID

### 2. Trigger API (`app/api/pod/trigger-amplification/route.ts`)
- **Endpoint:** `POST /api/pod/trigger-amplification`
- **Input:** `{ postId, postUrl }`
- **Flow:**
  1. Authenticate user via Supabase
  2. Find user's active pod membership
  3. Create `pod_activity` record
  4. Queue amplification job
- **Returns:** Job ID for tracking

### 3. Amplification Worker (`lib/workers/pod-amplification-worker.ts`)
- **Job:** Orchestrate pod-wide amplification
- **Process:**
  1. Find all active pod members (exclude post author)
  2. Create `pod_activities` for each member
  3. Queue individual repost jobs (staggered by 5 seconds)
- **Concurrency:** 5 jobs at once
- **Retry:** 3 attempts with exponential backoff

### 4. Repost Worker (`lib/workers/repost-worker.ts`) - **CRITICAL COMPONENT**
- **300+ lines of Playwright automation**
- **Process:**
  1. Fetch LinkedIn session cookies from Unipile API
  2. Launch headless Chromium browser
  3. Set session cookies for authentication
  4. Navigate to LinkedIn post URL
  5. Find "Repost" button (3 fallback selector strategies)
  6. Click repost confirmation
  7. Update `pod_activity` status
- **Error handling:**
  - Screenshot capture on failure
  - Retry with exponential backoff
  - Database status tracking (queued ‚Üí processing ‚Üí success/failed)
- **Concurrency:** 2 browsers max (rate limit protection)

### 5. Worker Starter (`scripts/start-workers.ts`)
- **Command:** `npm run workers`
- **Starts both workers** in single process
- **Graceful shutdown** on SIGTERM
- **Environment:** Loads `.env.local` via dotenv

### 6. Database Migrations
**Migration 1:** `20251116_fix_roderic_agency_id.sql`
- Fixed user's `agency_id` for testing
- ‚úÖ Applied successfully

**Migration 2:** `20251116_update_pod_activities_for_workers.sql`
- Added columns: `pod_id`, `member_id`, `activity_type`, `post_url`, `processed_at`, `completed_at`
- Updated status constraint: `queued | processing | success | failed`
- Created indexes for worker queries
- ‚úÖ Applied successfully

### 7. Test Data Script (`scripts/create-test-pod-data.ts`)
- Creates test pod (uses existing `client` as temporary pod)
- Creates 2 test auth users via Supabase Admin API
- Creates `users` and `pod_members` entries
- Adds user (Roderic) to test pod
- **Issue:** All created with **fake Unipile account IDs**:
  - `UNIPILE_TEST_ACCOUNT_1`
  - `UNIPILE_TEST_ACCOUNT_2`
  - `YOUR_REAL_UNIPILE_ACCOUNT_ID`
- ‚úÖ Script runs successfully, creates 5 pod members

---

## Files Created/Modified

**Created:**
- `lib/queues/pod-queue.ts` (81 lines)
- `app/api/pod/trigger-amplification/route.ts` (60 lines)
- `lib/workers/pod-amplification-worker.ts` (142 lines)
- `lib/workers/repost-worker.ts` (312 lines) ‚≠ê
- `scripts/start-workers.ts` (25 lines)
- `scripts/run-migrations.ts` (50 lines)
- `scripts/create-test-pod-data.ts` (221 lines)
- `scripts/check-unipile-accounts.ts` (70 lines)
- `supabase/migrations/20251116_fix_roderic_agency_id.sql`
- `supabase/migrations/20251116_update_pod_activities_for_workers.sql`
- `docs/plans/2025-11-16-v2-workflow-json-refactoring.md`
- `docs/plans/2025-11-16-pod-amplification-implementation.md`
- `docs/plans/2025-11-16-pod-amplification-design.md`
- `docs/POD_AMPLIFICATION_TESTING.md`

**Modified:**
- `package.json` (added `"workers": "tsx scripts/start-workers.ts"`)

**Total:** ~1200 lines of new code

---

## Current State

### ‚úÖ What's Working
1. **Redis:** Running on localhost:6379 (verified with `redis-cli ping`)
2. **Dev Server:** Running on port 3000 (health endpoint returns 200)
3. **Workers:** Both workers running in background (PID 87835, 87836)
4. **Database:** All migrations applied, test data populated
5. **Environment:** All env vars loaded correctly (dotenv fixed)
6. **Queue System:** Ready to accept jobs

### ‚ö†Ô∏è What's Blocked
1. **Real LinkedIn Testing:** All pod members have fake Unipile account IDs
2. **Playwright Automation:** Cannot test until real Unipile accounts connected
3. **End-to-End Flow:** Infrastructure works, but will fail at browser automation

### üîç Verification Results

**Service Health:**
```
‚úÖ Redis: PONG
‚úÖ Dev Server: {"status":"degraded"} (Supabase degraded, all else healthy)
‚úÖ Workers: 2 processes running
‚úÖ Database: Migrations applied
‚ùå Unipile Accounts: 0 real, 5 fake
```

**Pod Members Status:**
```
Total: 5 active pod members
Real Unipile Accounts: 0
Fake Unipile Accounts: 5
```

---

## Problems Encountered & Solutions

### Problem 1: Workers Failed to Start - Missing Env Vars
**Error:** `supabaseUrl is required`
**Cause:** Worker files didn't load `.env.local`
**Fix:** Added `config({ path: '.env.local' })` to all worker files
**Time:** 15 minutes

### Problem 2: Test Data Script - Email Column Not Found
**Error:** `Could not find the 'email' column of 'pod_members'`
**Cause:** Script tried to insert 'email' column that doesn't exist in schema
**Fix:** Removed all 'email' references from insert statements
**Time:** 20 minutes

### Problem 3: Upsert Conflict - No Unique Constraint
**Error:** `there is no unique or exclusion constraint matching the ON CONFLICT specification`
**Cause:** Used `onConflict: 'user_id'` but no unique constraint exists
**Fix:** Changed to regular `insert()` with duplicate error handling
**Time:** 10 minutes

### Problem 4: Fake Unipile Account IDs
**Issue:** All test data created with placeholder Unipile IDs
**Impact:** Workers will fail when trying to fetch LinkedIn sessions
**Status:** Deferred - waiting for real Unipile account setup

---

## Architecture Insights

### Current Schema Issues (To Be Refactored Tomorrow)

**Problem:** `clients` table represents businesses, but user expects "client" to mean individual person

**Current Hierarchy:**
```
Agency ‚Üí Clients (businesses) ‚Üí Users ‚Üí Pod Members
```

**Expected Hierarchy:**
```
Agency ‚Üí Clients (individuals) ‚Üí Optional Pod Membership
```

**Temporary Workaround:**
- Using `client_id` as `pod_id` throughout workers
- Comment in code: `// TEMPORARY: using client_id as pod_id`

**Tomorrow's Refactor Plan:**
1. Rename `clients` ‚Üí `companies` (or eliminate)
2. Create proper `pods` table with auto-generated names ("Courageous Bear")
3. Create `pod_memberships` join table
4. Update workers to use real `pod_id`

---

## Testing Status

### Infrastructure Testing: ‚úÖ READY
- Queue jobs can be created
- Workers process jobs
- Database updates occur
- Status tracking works

### LinkedIn Automation Testing: ‚è∏Ô∏è BLOCKED
- Requires real Unipile account IDs
- User set up Unipile "a couple days ago"
- Need to check if LinkedIn accounts are connected
- Need to update pod members with real account IDs

### Next Steps for Testing
1. **Check Unipile for connected accounts:**
   ```bash
   curl -X GET "${UNIPILE_DSN}/api/v1/accounts" \
     -H "X-API-KEY: ${UNIPILE_API_KEY}"
   ```

2. **If accounts exist:**
   - Update pod members with real Unipile account IDs
   - Trigger test amplification
   - Watch worker logs for Playwright automation
   - Verify LinkedIn repost occurs

3. **If no accounts:**
   - Connect LinkedIn accounts to Unipile first
   - Then proceed with testing

---

## Technical Debt

1. **Schema Refactor:** Clients ‚Üí Pods restructure (planned for tomorrow)
2. **Unipile Account Setup:** Need real account IDs for testing
3. **Rate Limiting:** 5-second stagger might not be enough for LinkedIn
4. **Selector Robustness:** LinkedIn UI changes may break repost button selectors
5. **Error Recovery:** Need better retry logic for transient failures

---

## Metrics

**Lines of Code:** ~1200 new lines
**Files Created:** 13
**Migrations:** 2 applied
**Workers:** 2 running
**Test Data:** 5 pod members created
**Session Time:** ~4 hours

---

## Decisions Made

1. **Ship Tonight, Refactor Tomorrow:** User confirmed proceed with current schema
2. **Queue Infrastructure First:** Focus on getting workers running before schema cleanup
3. **Fake Test Data OK:** Create test data with placeholders, update with real IDs later
4. **Two-Tier Queue System:** Separate amplification orchestration from individual reposts
5. **Playwright for Automation:** Use headless browser instead of LinkedIn API (more reliable)

---

## Next Session Plan

**Tomorrow:**
1. Schema refactor (clients ‚Üí pods)
2. Connect real LinkedIn accounts to Unipile (if not done)
3. Update pod members with real Unipile account IDs
4. Test end-to-end pod amplification
5. Verify Playwright automation works with real LinkedIn
6. Adjust selectors if LinkedIn UI has changed
7. Monitor rate limiting and adjust stagger timing

**Questions to Answer:**
- Do we have real Unipile accounts connected?
- What are their account IDs?
- Should we test with small pod (2-3 members) first?
- What's the acceptable failure rate for automation?

---

## Commit History (Current Session)

```
486c071 - security(pod-onboarding): fix critical security vulnerabilities
36fd66c - feat(pods): implement complete self-service onboarding system
[Session Start]
- Fixed workers env loading
- Fixed test data script schema mismatch
- Created check-unipile-accounts.ts
- Verified infrastructure working
```

**Next Commit:** Will include this SITREP + any Unipile account updates

---

## Status: Infrastructure Complete, Testing Blocked

**Ready to proceed:** Queue system + workers + database
**Blocked:** Need real Unipile account IDs for LinkedIn automation
**Deferred:** Schema refactor (tomorrow)

**Bottom Line:** Everything works except the final Playwright step because we don't have real LinkedIn sessions. The infrastructure is solid - just need real Unipile accounts to test actual posting.
