# Acceptance Criteria: Platform Stabilization Epic

**Date:** 2026-01-26
**Epic:** Platform Stabilization (Phase 2.1-2.3)

---

## Story 2.1: Fix Build Failure (OPENAI_API_KEY)

**As a** developer
**I want** the build to complete without requiring OPENAI_API_KEY at compile time
**So that** we can deploy to Vercel successfully

### Acceptance Criteria

| # | Criterion | Verification Method | Status |
|---|-----------|-------------------|--------|
| AC-1.1 | `npm run build` completes without error | Run locally | [ ] |
| AC-1.2 | No "Missing credentials" error during build | Check build logs | [ ] |
| AC-1.3 | OpenAI SDK initializes at runtime only | Code review | [ ] |
| AC-1.4 | All 117 API routes compile successfully | Build output | [ ] |
| AC-1.5 | Vercel preview deployment succeeds | Vercel dashboard | [ ] |
| AC-1.6 | Health check shows AgentKit healthy | `GET /api/health` | [ ] |

### Technical Notes
- **Root Cause:** OpenAI SDK initialized at module top-level in `/api/test-email-generation`
- **Fix Pattern:** Dynamic import or lazy initialization
- **Reference:** Similar fix in `lib/console/marketing-console.ts`

---

## Story 2.2: Fix Render Worker Env Vars

**As a** system
**I want** the Render background worker to have all required environment variables
**So that** background jobs (DM queue, webhooks) process correctly

### Acceptance Criteria

| # | Criterion | Verification Method | Status |
|---|-----------|-------------------|--------|
| AC-2.1 | REDIS_URL configured in Render dashboard | Render UI check | [ ] |
| AC-2.2 | SUPABASE_SERVICE_ROLE_KEY configured | Render UI check | [ ] |
| AC-2.3 | Worker process starts without error | Render logs | [ ] |
| AC-2.4 | Health check shows Redis healthy | `GET /api/health` | [ ] |
| AC-2.5 | Health check shows cache healthy | `GET /api/health` | [ ] |
| AC-2.6 | BullMQ job processes successfully | Add test job | [ ] |

### Required Environment Variables
```
REDIS_URL=redis://...
SUPABASE_SERVICE_ROLE_KEY=eyJ...
NEXT_PUBLIC_SUPABASE_URL=https://...
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJ...
```

### Render Service ID
- Worker: `srv-d519ifqli9vc73b002ug`

---

## Story 2.3: Auth Flow Manual Testing

**As a** user
**I want** to log in once and access both RevOS and AudienceOS
**So that** I don't need separate credentials for each app

### Acceptance Criteria

| # | Criterion | Verification Method | Status |
|---|-----------|-------------------|--------|
| AC-3.1 | Login at `/auth/login` succeeds | Manual test | [ ] |
| AC-3.2 | Session persists when navigating to `/dashboard` | Manual test | [ ] |
| AC-3.3 | Session persists when navigating to `/audienceos` | Manual test | [ ] |
| AC-3.4 | AppSwitcher shows in both apps | Visual check | [ ] |
| AC-3.5 | Logout clears session completely | Check cookies | [ ] |
| AC-3.6 | Protected routes redirect to login | Try direct URL | [ ] |
| AC-3.7 | Session survives browser refresh | Refresh test | [ ] |
| AC-3.8 | Different users see their own data | Multi-user test | [ ] |

### Test Accounts
| Account | Password | Tenant |
|---------|----------|--------|
| test@example.com | [from 1Password] | Demo Agency |

### Test Matrix
| Browser | Desktop | Mobile |
|---------|---------|--------|
| Chrome | [ ] | [ ] |
| Safari | [ ] | [ ] |
| Firefox | [ ] | [ ] |

---

## Definition of Done (Epic Level)

- [ ] All acceptance criteria marked PASS
- [ ] Zero ðŸ”´ HIGH risks remaining
- [ ] Build succeeds locally AND on Vercel
- [ ] Health check shows all services healthy
- [ ] Auth flow verified manually
- [ ] Documentation updated:
  - [ ] `/docs/05-planning/platform-stabilization/` complete
  - [ ] Slack canvas updated
  - [ ] Dashboard DUs logged
- [ ] Code review approved
- [ ] Merged to main

---

*Generated by Deputy - Pre-Implementation Verification Protocol*
